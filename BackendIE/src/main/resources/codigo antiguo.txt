Posible estructura:
compliancebot-backend/
├── backend-java/ # Spring Boot Backend Principal
│ ├── src/main/java/com/compliancebot/
│ │ ├── ComplianceBotApplication.java
│ │ ├── config/
│ │ │ ├── DatabaseConfig.java
│ │ │ ├── SecurityConfig.java
│ │ │ ├── SwaggerConfig.java
│ │ │ └── MLIntegrationConfig.java
│ │ ├── controller/ # 8+ Endpoints REST
│ │ │ ├── EmpresaController.java
│ │ │ ├── UsuarioController.java
│ │ │ ├── AuditoriaController.java
│ │ │ ├── PoliticaController.java
│ │ │ ├── RiesgoController.java
│ │ │ ├── DocumentoController.java
│ │ │ ├── MLController.java
│ │ │ └── ReporteController.java
│ │ ├── service/ # Lógica de negocio
│ │ │ ├── EmpresaService.java
│ │ │ ├── AuditoriaService.java
│ │ │ ├── ComplianceService.java
│ │ │ ├── RiskAssessmentService.java
│ │ │ └── MLIntegrationService.java
│ │ ├── model/ # 5+ Entidades JPA
│ │ │ ├── Empresa.java
│ │ │ ├── Usuario.java
│ │ │ ├── Auditoria.java
│ │ │ ├── Politica.java
│ │ │ ├── Riesgo.java
│ │ │ ├── Documento.java
│ │ │ └── Framework.java
│ │ ├── repository/ # JPA Repositories
│ │ │ ├── EmpresaRepository.java
│ │ │ ├── UsuarioRepository.java
│ │ │ ├── AuditoriaRepository.java
│ │ │ ├── PoliticaRepository.java
│ │ │ └── RiesgoRepository.java
│ │ ├── dto/ # DTOs para API
│ │ │ ├── request/
│ │ │ └── response/
ComplianceBot - Backend Completo con Spring
Boot + ML
1. Estructura del Proyecto

│ │ ├── exception/ # Manejo de excepciones
│ │ │ ├── GlobalExceptionHandler.java
│ │ │ └── CustomExceptions.java
│ │ └── validation/ # Validaciones custom
│ │ ├── ValidatorUtils.java
│ │ └── ComplianceValidators.java
│ ├── src/main/resources/
│ │ ├── application.yml
│ │ ├── data.sql
│ │ └── schema.sql
│ ├── src/test/java/ # Tests unitarios
│ │ ├── service/
│ │ ├── controller/
│ │ └── repository/
│ └── pom.xml
├── ml-service-python/ # Servicio ML mínimo
│ ├── app/
│ │ ├── main.py
│ │ ├── ml_models.py
│ │ └── schemas.py
│ ├── requirements.txt
│ └── Dockerfile
├── database/
│ ├── init_schema.sql
│ └── sample_data.sql
├── docker-compose.yml
└── README.md



2) BD:
-- database/init_schema.sql
-- ComplianceBot Database Schema - Versión Completa
-- Crear esquema principal
CREATE SCHEMA IF NOT EXISTS compliancebot;
SET search_path TO compliancebot;
-- 1. TABLA EMPRESAS (Entidad Principal)
CREATE TABLE empresas (
id BIGSERIAL PRIMARY KEY,
nombre VARCHAR(255) NOT NULL,
rut VARCHAR(12) UNIQUE NOT NULL,
industria VARCHAR(100) NOT NULL,
num_empleados INTEGER NOT NULL CHECK (num_empleados > 0),
ubicacion VARCHAR(200) NOT NULL,
telefono VARCHAR(20),
email VARCHAR(255),
descripcion TEXT,
fecha_fundacion DATE,
status VARCHAR(20) DEFAULT 'ACTIVE' CHECK (status IN ('ACTIVE', 'INACTIVE', 'SUSPENDE
created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
2. Base de Datos Actualizada (PostgreSQL)
2.1 Schema Principal

updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
deleted_at TIMESTAMP NULL
);
-- 2. TABLA USUARIOS (Gestión de acceso)
CREATE TABLE usuarios (
id BIGSERIAL PRIMARY KEY,
empresa_id BIGINT NOT NULL REFERENCES empresas(id) ON DELETE CASCADE,
nombre VARCHAR(255) NOT NULL,
apellido VARCHAR(255) NOT NULL,
email VARCHAR(255) NOT NULL,
password_hash VARCHAR(255) NOT NULL,
rol VARCHAR(50) NOT NULL CHECK (rol IN ('ADMIN', 'COMPLIANCE_OFFICER', 'AUDITOR', 'US
activo BOOLEAN DEFAULT true,
ultimo_login TIMESTAMP,
intentos_login INTEGER DEFAULT 0,
created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
deleted_at TIMESTAMP NULL,
UNIQUE(email, empresa_id)
);
-- 3. TABLA FRAMEWORKS (Marcos de compliance)
CREATE TABLE frameworks (
id BIGSERIAL PRIMARY KEY,
nombre VARCHAR(100) NOT NULL,
descripcion TEXT,
version VARCHAR(20),
tipo VARCHAR(50) CHECK (tipo IN ('INTERNACIONAL', 'NACIONAL', 'SECTORIAL')),
vigente BOOLEAN DEFAULT true,
created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
deleted_at TIMESTAMP NULL
);
-- 4. TABLA AUDITORIAS (Proceso de auditoría)
CREATE TABLE auditorias (
id BIGSERIAL PRIMARY KEY,
empresa_id BIGINT NOT NULL REFERENCES empresas(id) ON DELETE CASCADE,
framework_id BIGINT REFERENCES frameworks(id),
nombre VARCHAR(255) NOT NULL,
descripcion TEXT,
tipo VARCHAR(50) NOT NULL CHECK (tipo IN ('INTERNA', 'EXTERNA', 'MOCK', 'CONTINUA')),
estado VARCHAR(50) DEFAULT 'PLANIFICADA'
CHECK (estado IN ('PLANIFICADA', 'EN_PROGRESO', 'COMPLETADA', 'CANCELADA')),
auditor_principal_id BIGINT REFERENCES usuarios(id),
auditor_externo VARCHAR(255),
fecha_inicio DATE,
fecha_fin DATE,
fecha_planificada DATE,
score_final DECIMAL(5,2) CHECK (score_final >= 0 AND score_final <= 100),
hallazgos_criticos INTEGER DEFAULT 0,
hallazgos_mayores INTEGER DEFAULT 0,
hallazgos_menores INTEGER DEFAULT 0,
observaciones TEXT,
created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,

updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
deleted_at TIMESTAMP NULL
);
-- 5. TABLA POLITICAS (Políticas de compliance)
CREATE TABLE politicas (
id BIGSERIAL PRIMARY KEY,
empresa_id BIGINT NOT NULL REFERENCES empresas(id) ON DELETE CASCADE,
framework_id BIGINT REFERENCES frameworks(id),
auditoria_id BIGINT REFERENCES auditorias(id),
titulo VARCHAR(255) NOT NULL,
contenido TEXT NOT NULL,
tipo VARCHAR(50) NOT NULL CHECK (tipo IN ('POLITICA', 'PROCEDIMIENTO', 'MANUAL', 'PRO
estado VARCHAR(30) DEFAULT 'BORRADOR'
CHECK (estado IN ('BORRADOR', 'REVISION', 'APROBADA', 'ACTIVA', 'ARCHIVADA')),
version VARCHAR(20) DEFAULT '1.0',
ai_generada BOOLEAN DEFAULT false,
score_compliance DECIMAL(5,2) CHECK (score_compliance >= 0 AND score_compliance <= 10
aprobada_por BIGINT REFERENCES usuarios(id),
fecha_aprobacion TIMESTAMP,
fecha_revision_proxima DATE,
created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
deleted_at TIMESTAMP NULL
);
-- 6. TABLA RIESGOS (Gestión de riesgos)
CREATE TABLE riesgos (
id BIGSERIAL PRIMARY KEY,
empresa_id BIGINT NOT NULL REFERENCES empresas(id) ON DELETE CASCADE,
framework_id BIGINT REFERENCES frameworks(id),
auditoria_id BIGINT REFERENCES auditorias(id),
titulo VARCHAR(255) NOT NULL,
descripcion TEXT NOT NULL,
categoria VARCHAR(100),
probabilidad VARCHAR(20) CHECK (probabilidad IN ('MUY_BAJA', 'BAJA', 'MEDIA', 'ALTA',
impacto VARCHAR(20) CHECK (impacto IN ('MUY_BAJO', 'BAJO', 'MEDIO', 'ALTO', 'MUY_ALTO
nivel_riesgo VARCHAR(20) GENERATED ALWAYS AS (
CASE
WHEN probabilidad = 'MUY_ALTA' AND impacto = 'MUY_ALTO' THEN 'CRITICO'
WHEN (probabilidad IN ('ALTA', 'MUY_ALTA') AND impacto IN ('ALTO', 'MUY_ALTO'
WHEN (probabilidad = 'MEDIA' OR impacto = 'MEDIO') THEN 'MEDIO'
ELSE 'BAJO'
END
) STORED,
estado VARCHAR(30) DEFAULT 'IDENTIFICADO'
CHECK (estado IN ('IDENTIFICADO', 'ANALIZADO', 'EN_TRATAMIENTO', 'MITIGADO', 'ACE
responsable_id BIGINT REFERENCES usuarios(id),
fecha_identificacion DATE DEFAULT CURRENT_DATE,
fecha_limite_mitigacion DATE,
plan_mitigacion TEXT,
costo_estimado DECIMAL(15,2),
created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
deleted_at TIMESTAMP NULL
);

-- 7. TABLA DOCUMENTOS (Documentos de soporte)
CREATE TABLE documentos (
id BIGSERIAL PRIMARY KEY,
empresa_id BIGINT NOT NULL REFERENCES empresas(id) ON DELETE CASCADE,
politica_id BIGINT REFERENCES politicas(id),
auditoria_id BIGINT REFERENCES auditorias(id),
nombre VARCHAR(255) NOT NULL,
descripcion TEXT,
tipo_documento VARCHAR(50) CHECK (tipo_documento IN ('EVIDENCIA', 'CERTIFICADO', 'REP
ruta_archivo VARCHAR(500),
tamano_bytes BIGINT,
mime_type VARCHAR(100),
checksum VARCHAR(255),
confidencial BOOLEAN DEFAULT false,
version VARCHAR(20) DEFAULT '1.0',
subido_por BIGINT REFERENCES usuarios(id),
created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
deleted_at TIMESTAMP NULL
);
-- 8. TABLA REPORTES (Reportes generados)
CREATE TABLE reportes (
id BIGSERIAL PRIMARY KEY,
empresa_id BIGINT NOT NULL REFERENCES empresas(id) ON DELETE CASCADE,
auditoria_id BIGINT REFERENCES auditorias(id),
usuario_id BIGINT REFERENCES usuarios(id),
nombre VARCHAR(255) NOT NULL,
tipo_reporte VARCHAR(50) NOT NULL
CHECK (tipo_reporte IN ('AUDITORIA', 'RIESGO', 'COMPLIANCE', 'EJECUTIVO')),
formato VARCHAR(20) DEFAULT 'PDF' CHECK (formato IN ('PDF', 'EXCEL', 'JSON', 'HTML'))
contenido TEXT,
ruta_archivo VARCHAR(500),
parametros_generacion JSONB,
estado VARCHAR(30) DEFAULT 'GENERANDO'
CHECK (estado IN ('GENERANDO', 'COMPLETADO', 'ERROR')),
fecha_generacion TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
deleted_at TIMESTAMP NULL
);
-- ÍNDICES PARA PERFORMANCE
CREATE INDEX idx_empresas_rut ON empresas(rut) WHERE deleted_at IS NULL;
CREATE INDEX idx_empresas_industria ON empresas(industria) WHERE deleted_at IS NULL;
CREATE INDEX idx_usuarios_empresa ON usuarios(empresa_id) WHERE deleted_at IS NULL;
CREATE INDEX idx_usuarios_email ON usuarios(email) WHERE deleted_at IS NULL;
CREATE INDEX idx_auditorias_empresa_estado ON auditorias(empresa_id, estado) WHERE delete
CREATE INDEX idx_politicas_empresa_estado ON politicas(empresa_id, estado) WHERE deleted_
CREATE INDEX idx_riesgos_empresa_nivel ON riesgos(empresa_id, nivel_riesgo) WHERE deleted
CREATE INDEX idx_documentos_empresa ON documentos(empresa_id) WHERE deleted_at IS NULL;
CREATE INDEX idx_reportes_empresa_tipo ON reportes(empresa_id, tipo_reporte) WHERE delete
-- TRIGGERS PARA UPDATED_AT
CREATE OR REPLACE FUNCTION update_updated_at_column()
RETURNS TRIGGER AS $$

BEGIN
NEW.updated_at = CURRENT_TIMESTAMP;
RETURN NEW;
END;
$$ language 'plpgsql';
CREATE TRIGGER update_empresas_updated_at BEFORE UPDATE ON empresas
FOR EACH ROW EXECUTE FUNCTION update_updated_at_column();
CREATE TRIGGER update_usuarios_updated_at BEFORE UPDATE ON usuarios
FOR EACH ROW EXECUTE FUNCTION update_updated_at_column();
CREATE TRIGGER update_auditorias_updated_at BEFORE UPDATE ON auditorias
FOR EACH ROW EXECUTE FUNCTION update_updated_at_column();
CREATE TRIGGER update_politicas_updated_at BEFORE UPDATE ON politicas
FOR EACH ROW EXECUTE FUNCTION update_updated_at_column();
CREATE TRIGGER update_riesgos_updated_at BEFORE UPDATE ON riesgos
FOR EACH ROW EXECUTE FUNCTION update_updated_at_column();
-- FUNCIÓN PARA SOFT DELETE
CREATE OR REPLACE FUNCTION soft_delete_record(table_name TEXT, record_id BIGINT)
RETURNS BOOLEAN AS $$
BEGIN
EXECUTE format('UPDATE %I SET deleted_at = CURRENT_TIMESTAMP WHERE id = $1 AND delete
RETURN FOUND;
END;
$$ LANGUAGE plpgsql;


ejemplos:
-- database/sample_data.sql
SET search_path TO compliancebot;
-- Insertar frameworks base
INSERT INTO frameworks (nombre, descripcion, tipo, version) VALUES
('Higiene Alimentaria', 'Protocolos de higiene para establecimientos de alimentos', 'SECT
('Seguridad Laboral', 'Normas de seguridad laboral básicas', 'NACIONAL', '2024.1'),
('Protección de Datos', 'Ley de protección de datos personales', 'NACIONAL', '2024.1'),
('SOC 2', 'Service Organization Control 2', 'INTERNACIONAL', '2017'),
('ISO 27001', 'Gestión de Seguridad de la Información', 'INTERNACIONAL', '2022');
-- Insertar empresa ejemplo
INSERT INTO empresas (nombre, rut, industria, num_empleados, ubicacion, telefono, email,
('Restaurante El Buen Sabor', '76543210-9', 'restaurante', 15, 'Santiago, Chile', '+56912
('Cafetería Tech Hub', '87654321-0', 'cafeteria', 8, 'Valparaíso, Chile', '+56987654321',
('Panadería Artesanal', '98765432-1', 'panaderia', 12, 'Concepción, Chile', '+56945678912
-- Insertar usuarios ejemplo
INSERT INTO usuarios (empresa_id, nombre, apellido, email, password_hash, rol) VALUES
(1, 'María', 'González', 'maria.gonzalez@elbuensabor.cl', '$2a$10$example', 'ADMIN'),
(1, 'Juan', 'Pérez', 'juan.perez@elbuensabor.cl', '$2a$10$example', 'COMPLIANCE_OFFICER')
(2, 'Ana', 'Silva', 'ana.silva@techhub.cl', '$2a$10$example', 'ADMIN'),
(3, 'Carlos', 'Mendoza', 'carlos.mendoza@panartesanal.cl', '$2a$10$example', 'ADMIN');
-- Insertar auditorías ejemplo
INSERT INTO auditorias (empresa_id, framework_id, nombre, descripcion, tipo, estado, audi
(1, 1, 'Auditoría Higiene Alimentaria 2025', 'Auditoría anual de protocolos de higiene',
2.2 Datos de Ejemplo

(1, 2, 'Revisión Seguridad Laboral', 'Evaluación de condiciones de trabajo', 'INTERNA', '
(2, 1, 'Mock Audit - Higiene', 'Simulacro de auditoría para preparación', 'MOCK', 'COMPLE
-- Insertar políticas ejemplo
INSERT INTO politicas (empresa_id, framework_id, auditoria_id, titulo, contenido, tipo, e
(1, 1, 1, 'Política de Higiene de Alimentos', 'Esta política establece los lineamientos p
(1, 2, 2, 'Protocolo de Seguridad en Cocina', 'Procedimientos de seguridad para personal
(2, 1, 3, 'Manual de Limpieza y Desinfección', 'Guía completa para limpieza de áreas de p
-- Insertar riesgos ejemplo
INSERT INTO riesgos (empresa_id, framework_id, titulo, descripcion, categoria, probabilid
(1, 1, 'Contaminación Cruzada', 'Riesgo de contaminación entre alimentos crudos y cocidos
(1, 2, 'Accidente con Cuchillos', 'Posible lesión por mal uso de herramientas cortantes',
(2, 1, 'Limpieza Inadecuada', 'Falta de protocolos de limpieza profunda', 'Operacional',
-- Insertar documentos ejemplo
INSERT INTO documentos (empresa_id, politica_id, nombre, descripcion, tipo_documento, rut
(1, 1, 'Certificado SEREMI', 'Certificado vigente de autorización sanitaria', 'CERTIFICAD
(1, 2, 'Evidencia Capacitación', 'Registro de capacitación en seguridad laboral', 'EVIDEN
(2, 3, 'Template Checklist', 'Plantilla para checklist diario de limpieza', 'TEMPLATE', '



------------------------------------------------------------------------------
Anterior posibles estructuras:
// model/Empresa.java
package com.compliancebot.model;
import jakarta.persistence.*;
import jakarta.validation.constraints.*;
import org.hibernate.annotations.CreationTimestamp;
import org.hibernate.annotations.UpdateTimestamp;
import org.hibernate.annotations.Where;
import java.time.LocalDate;
import java.time.LocalDateTime;
import java.util.List;
@Entity
@Table(name = "empresas")
@Where(clause = "deleted_at IS NULL")
public class Empresa {
@Id
@GeneratedValue(strategy = GenerationType.IDENTITY)
private Long id;
@NotBlank(message = "El nombre es obligatorio")
@Size(max = 255, message = "El nombre no puede exceder 255 caracteres")
@Column(name = "nombre", nullable = false)
private String nombre;
@NotBlank(message = "El RUT es obligatorio")
@Pattern(regexp = "^[0-9]{7,8}-[0-9Kk]$", message = "Formato de RUT inválido")
@Column(name = "rut", unique = true, nullable = false)
private String rut;
@NotBlank(message = "La industria es obligatoria")
@Column(name = "industria", nullable = false)
private String industria;
@NotNull(message = "El número de empleados es obligatorio")
@Min(value = 1, message = "Debe tener al menos 1 empleado")
3.2 Modelos JPA (5+ Entidades)

@Column(name = "num_empleados", nullable = false)
private Integer numEmpleados;
@NotBlank(message = "La ubicación es obligatoria")
@Column(name = "ubicacion", nullable = false)
private String ubicacion;
@Pattern(regexp = "^\\+?[0-9]{8,15}$", message = "Formato de teléfono inválido")
@Column(name = "telefono")
private String telefono;
@Email(message = "Email inválido")
@Column(name = "email")
private String email;
@Column(name = "descripcion", columnDefinition = "TEXT")
private String descripcion;
@Column(name = "fecha_fundacion")
private LocalDate fechaFundacion;
@Enumerated(EnumType.STRING)
@Column(name = "status")
private StatusEmpresa status = StatusEmpresa.ACTIVE;
@CreationTimestamp
@Column(name = "created_at", nullable = false, updatable = false)
private LocalDateTime createdAt;
@UpdateTimestamp
@Column(name = "updated_at")
private LocalDateTime updatedAt;
@Column(name = "deleted_at")
private LocalDateTime deletedAt;
// Relaciones
@OneToMany(mappedBy = "empresa", cascade = CascadeType.ALL, fetch = FetchType.LAZY)
private List<Usuario> usuarios;
@OneToMany(mappedBy = "empresa", cascade = CascadeType.ALL, fetch = FetchType.LAZY)
private List<Auditoria> auditorias;
@OneToMany(mappedBy = "empresa", cascade = CascadeType.ALL, fetch = FetchType.LAZY)
private List<Politica> politicas;
@OneToMany(mappedBy = "empresa", cascade = CascadeType.ALL, fetch = FetchType.LAZY)
private List<Riesgo> riesgos;
// Constructores
public Empresa() {}
public Empresa(String nombre, String rut, String industria, Integer numEmpleados, Str
this.nombre = nombre;
this.rut = rut;
this.industria = industria;

this.numEmpleados = numEmpleados;
this.ubicacion = ubicacion;
}
// Getters y Setters
public Long getId() { return id; }
public void setId(Long id) { this.id = id; }
public String getNombre() { return nombre; }
public void setNombre(String nombre) { this.nombre = nombre; }
public String getRut() { return rut; }
public void setRut(String rut) { this.rut = rut; }
public String getIndustria() { return industria; }
public void setIndustria(String industria) { this.industria = industria; }
public Integer getNumEmpleados() { return numEmpleados; }
public void setNumEmpleados(Integer numEmpleados) { this.numEmpleados = numEmpleados;
public String getUbicacion() { return ubicacion; }
public void setUbicacion(String ubicacion) { this.ubicacion = ubicacion; }
public String getTelefono() { return telefono; }
public void setTelefono(String telefono) { this.telefono = telefono; }
public String getEmail() { return email; }
public void setEmail(String email) { this.email = email; }
public String getDescripcion() { return descripcion; }
public void setDescripcion(String descripcion) { this.descripcion = descripcion; }
public LocalDate getFechaFundacion() { return fechaFundacion; }
public void setFechaFundacion(LocalDate fechaFundacion) { this.fechaFundacion = fecha
public StatusEmpresa getStatus() { return status; }
public void setStatus(StatusEmpresa status) { this.status = status; }
public LocalDateTime getCreatedAt() { return createdAt; }
public LocalDateTime getUpdatedAt() { return updatedAt; }
public LocalDateTime getDeletedAt() { return deletedAt; }
public void setDeletedAt(LocalDateTime deletedAt) { this.deletedAt = deletedAt; }
public List<Usuario> getUsuarios() { return usuarios; }
public void setUsuarios(List<Usuario> usuarios) { this.usuarios = usuarios; }
public List<Auditoria> getAuditorias() { return auditorias; }
public void setAuditorias(List<Auditoria> auditorias) { this.auditorias = auditorias;
// Métodos de utilidad
public boolean isActive() {
return status == StatusEmpresa.ACTIVE && deletedAt == null;
}
public void softDelete() {
this.deletedAt = LocalDateTime.now();

this.status = StatusEmpresa.INACTIVE;
}
// Enum interno
public enum StatusEmpresa {
ACTIVE, INACTIVE, SUSPENDED
}
}
// model/Usuario.java
package com.compliancebot.model;
import jakarta.persistence.*;
import jakarta.validation.constraints.*;
import org.hibernate.annotations.CreationTimestamp;
import org.hibernate.annotations.UpdateTimestamp;
import org.hibernate.annotations.Where;
import java.time.LocalDateTime;
import java.util.List;
@Entity
@Table(name = "usuarios", uniqueConstraints = {
@UniqueConstraint(columnNames = {"email", "empresa_id"})
})
@Where(clause = "deleted_at IS NULL")
public class Usuario {
@Id
@GeneratedValue(strategy = GenerationType.IDENTITY)
private Long id;
@ManyToOne(fetch = FetchType.LAZY)
@JoinColumn(name = "empresa_id", nullable = false)
private Empresa empresa;
@NotBlank(message = "El nombre es obligatorio")
@Size(max = 255)
@Column(name = "nombre", nullable = false)
private String nombre;
@NotBlank(message = "El apellido es obligatorio")
@Size(max = 255)
@Column(name = "apellido", nullable = false)
private String apellido;
@NotBlank(message = "El email es obligatorio")
@Email(message = "Email inválido")
@Column(name = "email", nullable = false)
private String email;
@NotBlank(message = "La contraseña es obligatoria")
@Column(name = "password_hash", nullable = false)
private String passwordHash;
@NotNull(message = "El rol es obligatorio")

@Enumerated(EnumType.STRING)
@Column(name = "rol", nullable = false)
private RolUsuario rol;
@Column(name = "activo")
private Boolean activo = true;
@Column(name = "ultimo_login")
private LocalDateTime ultimoLogin;
@Column(name = "intentos_login")
private Integer intentosLogin = 0;
@CreationTimestamp
@Column(name = "created_at", nullable = false, updatable = false)
private LocalDateTime createdAt;
@UpdateTimestamp
@Column(name = "updated_at")
private LocalDateTime updatedAt;
@Column(name = "deleted_at")
private LocalDateTime deletedAt;
// Relaciones
@OneToMany(mappedBy = "auditorPrincipal", fetch = FetchType.LAZY)
private List<Auditoria> auditoriasComoLider;
@OneToMany(mappedBy = "responsable", fetch = FetchType.LAZY)
private List<Riesgo> riesgosAsignados;
// Constructores
public Usuario() {}
public Usuario(String nombre, String apellido, String email, String passwordHash,

RolUsuario rol, Empresa empresa) {

this.nombre = nombre;
this.apellido = apellido;
this.email = email;
this.passwordHash = passwordHash;
this.rol = rol;
this.empresa = empresa;
}
// Getters y Setters completos...
public Long getId() { return id; }
public void setId(Long id) { this.id = id; }
public Empresa getEmpresa() { return empresa; }
public void setEmpresa(Empresa empresa) { this.empresa = empresa; }
public String getNombre() { return nombre; }
public void setNombre(String nombre) { this.nombre = nombre; }
public String getApellido() { return apellido; }
public void setApellido(String apellido) { this.apellido = apellido; }

public String getEmail() { return email; }
public void setEmail(String email) { this.email = email; }
public String getPasswordHash() { return passwordHash; }
public void setPasswordHash(String passwordHash) { this.passwordHash = passwordHash;
public RolUsuario getRol() { return rol; }
public void setRol(RolUsuario rol) { this.rol = rol; }
public Boolean getActivo() { return activo; }
public void setActivo(Boolean activo) { this.activo = activo; }
public LocalDateTime getUltimoLogin() { return ultimoLogin; }
public void setUltimoLogin(LocalDateTime ultimoLogin) { this.ultimoLogin = ultimoLogi
public Integer getIntentosLogin() { return intentosLogin; }
public void setIntentosLogin(Integer intentosLogin) { this.intentosLogin = intentosLo
public LocalDateTime getCreatedAt() { return createdAt; }
public LocalDateTime getUpdatedAt() { return updatedAt; }
public LocalDateTime getDeletedAt() { return deletedAt; }
public void setDeletedAt(LocalDateTime deletedAt) { this.deletedAt = deletedAt; }
// Métodos de utilidad
public String getNombreCompleto() {
return nombre + " " + apellido;
}
public boolean isActive() {
return activo && deletedAt == null;
}
public void incrementarIntentosLogin() {
this.intentosLogin++;
if (this.intentosLogin >= 5) {
this.activo = false;
}
}
public void resetIntentosLogin() {
this.intentosLogin = 0;
this.ultimoLogin = LocalDateTime.now();
}
// Enum interno
public enum RolUsuario {
ADMIN, COMPLIANCE_OFFICER, AUDITOR, USER
}
}
// model/Auditoria.java (Entidad completa similar)
package com.compliancebot.model;
import jakarta.persistence.*;
import jakarta.validation.constraints.*;

import org.hibernate.annotations.CreationTimestamp;
import org.hibernate.annotations.UpdateTimestamp;
import org.hibernate.annotations.Where;
import java.math.BigDecimal;
import java.time.LocalDate;
import java.time.LocalDateTime;
import java.util.List;
@Entity
@Table(name = "auditorias")
@Where(clause = "deleted_at IS NULL")
public class Auditoria {
@Id
@GeneratedValue(strategy = GenerationType.IDENTITY)
private Long id;
@ManyToOne(fetch = FetchType.LAZY)
@JoinColumn(name = "empresa_id", nullable = false)
private Empresa empresa;
@ManyToOne(fetch = FetchType.LAZY)
@JoinColumn(name = "framework_id")
private Framework framework;
@NotBlank(message = "El nombre de la auditoría es obligatorio")
@Size(max = 255)
@Column(name = "nombre", nullable = false)
private String nombre;
@Column(name = "descripcion", columnDefinition = "TEXT")
private String descripcion;
@NotNull(message = "El tipo de auditoría es obligatorio")
@Enumerated(EnumType.STRING)
@Column(name = "tipo", nullable = false)
private TipoAuditoria tipo;
@Enumerated(EnumType.STRING)
@Column(name = "estado")
private EstadoAuditoria estado = EstadoAuditoria.PLANIFICADA;
@ManyToOne(fetch = FetchType.LAZY)
@JoinColumn(name = "auditor_principal_id")
private Usuario auditorPrincipal;
@Column(name = "auditor_externo")
private String auditorExterno;
@Column(name = "fecha_inicio")
private LocalDate fechaInicio;
@Column(name = "fecha_fin")
private LocalDate fechaFin;

@Column(name = "fecha_planificada")
private LocalDate fechaPlanificada;
@DecimalMin(value = "0.0", message = "El score final debe ser mayor o igual a 0")
@DecimalMax(value = "100.0", message = "El score final debe ser menor o igual a 100")
@Column(name = "score_final", precision = 5, scale = 2)
private BigDecimal scoreFinal;
@Min(value = 0, message = "Los hallazgos críticos no pueden ser negativos")
@Column(name = "hallazgos_criticos")
private Integer hallazgosCriticos = 0;
@Min(value = 0, message = "Los hallazgos mayores no pueden ser negativos")
@Column(name = "hallazgos_mayores")
private Integer hallazgosMayores = 0;
@Min(value = 0, message = "Los hallazgos menores no pueden ser negativos")
@Column(name = "hallazgos_menores")
private Integer hallazgosMenores = 0;
@Column(name = "observaciones", columnDefinition = "TEXT")
private String observaciones;
@CreationTimestamp
@Column(name = "created_at", nullable = false, updatable = false)
private LocalDateTime createdAt;
@UpdateTimestamp
@Column(name = "updated_at")
private LocalDateTime updatedAt;
@Column(name = "deleted_at")
private LocalDateTime deletedAt;
// Relaciones
@OneToMany(mappedBy = "auditoria", cascade = CascadeType.ALL, fetch = FetchType.LAZY)
private List<Politica> politicas;
@OneToMany(mappedBy = "auditoria", cascade = CascadeType.ALL, fetch = FetchType.LAZY)
private List<Riesgo> riesgos;
@OneToMany(mappedBy = "auditoria", cascade = CascadeType.ALL, fetch = FetchType.LAZY)
private List<Reporte> reportes;
// Constructores
public Auditoria() {}
public Auditoria(String nombre, TipoAuditoria tipo, Empresa empresa, Framework framew
this.nombre = nombre;
this.tipo = tipo;
this.empresa = empresa;
this.framework = framework;
}
// Getters y Setters completos...
// [Implementar todos los getters y setters]

// Métodos de utilidad
public boolean isCompletada() {
return estado == EstadoAuditoria.COMPLETADA;
}
public boolean isEnProgreso() {
return estado == EstadoAuditoria.EN_PROGRESO;
}
public Integer getTotalHallazgos() {
return (hallazgosCriticos != null ? hallazgosCriticos : 0) +
(hallazgosMayores != null ? hallazgosMayores : 0) +
(hallazgosMenores != null ? hallazgosMenores : 0);

}
public String getNivelRiesgoGeneral() {
if (hallazgosCriticos != null && hallazgosCriticos > 0) {
return "CRÍTICO";
} else if (hallazgosMayores != null && hallazgosMayores > 2) {
return "ALTO";
} else if (getTotalHallazgos() > 5) {
return "MEDIO";
} else {
return "BAJO";
}
}
// Enums internos
public enum TipoAuditoria {
INTERNA, EXTERNA, MOCK, CONTINUA
}
public enum EstadoAuditoria {
PLANIFICADA, EN_PROGRESO, COMPLETADA, CANCELADA
}
}
// model/Framework.java, model/Politica.java, model/Riesgo.java, model/Documento.java, mo
// [Implementar de manera similar con validaciones, relaciones y métodos de utilidad]

----------------------------------------------------------------------------------------------
3.2 Modelos JPA (5+ Entidades)

@Column(name = "num_empleados", nullable = false)
private Integer numEmpleados;
@NotBlank(message = "La ubicación es obligatoria")
@Column(name = "ubicacion", nullable = false)
private String ubicacion;
@Pattern(regexp = "^\\+?[0-9]{8,15}$", message = "Formato de teléfono inválido")
@Column(name = "telefono")
private String telefono;
@Email(message = "Email inválido")
@Column(name = "email")
private String email;
@Column(name = "descripcion", columnDefinition = "TEXT")
private String descripcion;
@Column(name = "fecha_fundacion")
private LocalDate fechaFundacion;
@Enumerated(EnumType.STRING)
@Column(name = "status")
private StatusEmpresa status = StatusEmpresa.ACTIVE;
@CreationTimestamp
@Column(name = "created_at", nullable = false, updatable = false)
private LocalDateTime createdAt;
@UpdateTimestamp
@Column(name = "updated_at")
private LocalDateTime updatedAt;
@Column(name = "deleted_at")
private LocalDateTime deletedAt;
// Relaciones
@OneToMany(mappedBy = "empresa", cascade = CascadeType.ALL, fetch = FetchType.LAZY)
private List<Usuario> usuarios;
@OneToMany(mappedBy = "empresa", cascade = CascadeType.ALL, fetch = FetchType.LAZY)
private List<Auditoria> auditorias;
@OneToMany(mappedBy = "empresa", cascade = CascadeType.ALL, fetch = FetchType.LAZY)
private List<Politica> politicas;
@OneToMany(mappedBy = "empresa", cascade = CascadeType.ALL, fetch = FetchType.LAZY)
private List<Riesgo> riesgos;
// Constructores
public Empresa() {}
public Empresa(String nombre, String rut, String industria, Integer numEmpleados, Str
this.nombre = nombre;
this.rut = rut;
this.industria = industria;

this.numEmpleados = numEmpleados;
this.ubicacion = ubicacion;
}
// Getters y Setters
public Long getId() { return id; }
public void setId(Long id) { this.id = id; }
public String getNombre() { return nombre; }
public void setNombre(String nombre) { this.nombre = nombre; }
public String getRut() { return rut; }
public void setRut(String rut) { this.rut = rut; }
public String getIndustria() { return industria; }
public void setIndustria(String industria) { this.industria = industria; }
public Integer getNumEmpleados() { return numEmpleados; }
public void setNumEmpleados(Integer numEmpleados) { this.numEmpleados = numEmpleados;
public String getUbicacion() { return ubicacion; }
public void setUbicacion(String ubicacion) { this.ubicacion = ubicacion; }
public String getTelefono() { return telefono; }
public void setTelefono(String telefono) { this.telefono = telefono; }
public String getEmail() { return email; }
public void setEmail(String email) { this.email = email; }
public String getDescripcion() { return descripcion; }
public void setDescripcion(String descripcion) { this.descripcion = descripcion; }
public LocalDate getFechaFundacion() { return fechaFundacion; }
public void setFechaFundacion(LocalDate fechaFundacion) { this.fechaFundacion = fecha
public StatusEmpresa getStatus() { return status; }
public void setStatus(StatusEmpresa status) { this.status = status; }
public LocalDateTime getCreatedAt() { return createdAt; }
public LocalDateTime getUpdatedAt() { return updatedAt; }
public LocalDateTime getDeletedAt() { return deletedAt; }
public void setDeletedAt(LocalDateTime deletedAt) { this.deletedAt = deletedAt; }
public List<Usuario> getUsuarios() { return usuarios; }
public void setUsuarios(List<Usuario> usuarios) { this.usuarios = usuarios; }
public List<Auditoria> getAuditorias() { return auditorias; }
public void setAuditorias(List<Auditoria> auditorias) { this.auditorias = auditorias;
// Métodos de utilidad
public boolean isActive() {
return status == StatusEmpresa.ACTIVE && deletedAt == null;
}
public void softDelete() {
this.deletedAt = LocalDateTime.now();

this.status = StatusEmpresa.INACTIVE;
}
// Enum interno
public enum StatusEmpresa {
ACTIVE, INACTIVE, SUSPENDED
}
}
// model/Usuario.java
package com.compliancebot.model;
import jakarta.persistence.*;
import jakarta.validation.constraints.*;
import org.hibernate.annotations.CreationTimestamp;
import org.hibernate.annotations.UpdateTimestamp;
import org.hibernate.annotations.Where;
import java.time.LocalDateTime;
import java.util.List;
@Entity
@Table(name = "usuarios", uniqueConstraints = {
@UniqueConstraint(columnNames = {"email", "empresa_id"})
})
@Where(clause = "deleted_at IS NULL")
public class Usuario {
@Id
@GeneratedValue(strategy = GenerationType.IDENTITY)
private Long id;
@ManyToOne(fetch = FetchType.LAZY)
@JoinColumn(name = "empresa_id", nullable = false)
private Empresa empresa;
@NotBlank(message = "El nombre es obligatorio")
@Size(max = 255)
@Column(name = "nombre", nullable = false)
private String nombre;
@NotBlank(message = "El apellido es obligatorio")
@Size(max = 255)
@Column(name = "apellido", nullable = false)
private String apellido;
@NotBlank(message = "El email es obligatorio")
@Email(message = "Email inválido")
@Column(name = "email", nullable = false)
private String email;
@NotBlank(message = "La contraseña es obligatoria")
@Column(name = "password_hash", nullable = false)
private String passwordHash;
@NotNull(message = "El rol es obligatorio")

@Enumerated(EnumType.STRING)
@Column(name = "rol", nullable = false)
private RolUsuario rol;
@Column(name = "activo")
private Boolean activo = true;
@Column(name = "ultimo_login")
private LocalDateTime ultimoLogin;
@Column(name = "intentos_login")
private Integer intentosLogin = 0;
@CreationTimestamp
@Column(name = "created_at", nullable = false, updatable = false)
private LocalDateTime createdAt;
@UpdateTimestamp
@Column(name = "updated_at")
private LocalDateTime updatedAt;
@Column(name = "deleted_at")
private LocalDateTime deletedAt;
// Relaciones
@OneToMany(mappedBy = "auditorPrincipal", fetch = FetchType.LAZY)
private List<Auditoria> auditoriasComoLider;
@OneToMany(mappedBy = "responsable", fetch = FetchType.LAZY)
private List<Riesgo> riesgosAsignados;
// Constructores
public Usuario() {}
public Usuario(String nombre, String apellido, String email, String passwordHash,

RolUsuario rol, Empresa empresa) {

this.nombre = nombre;
this.apellido = apellido;
this.email = email;
this.passwordHash = passwordHash;
this.rol = rol;
this.empresa = empresa;
}
// Getters y Setters completos...
public Long getId() { return id; }
public void setId(Long id) { this.id = id; }
public Empresa getEmpresa() { return empresa; }
public void setEmpresa(Empresa empresa) { this.empresa = empresa; }
public String getNombre() { return nombre; }
public void setNombre(String nombre) { this.nombre = nombre; }
public String getApellido() { return apellido; }
public void setApellido(String apellido) { this.apellido = apellido; }

public String getEmail() { return email; }
public void setEmail(String email) { this.email = email; }
public String getPasswordHash() { return passwordHash; }
public void setPasswordHash(String passwordHash) { this.passwordHash = passwordHash;
public RolUsuario getRol() { return rol; }
public void setRol(RolUsuario rol) { this.rol = rol; }
public Boolean getActivo() { return activo; }
public void setActivo(Boolean activo) { this.activo = activo; }
public LocalDateTime getUltimoLogin() { return ultimoLogin; }
public void setUltimoLogin(LocalDateTime ultimoLogin) { this.ultimoLogin = ultimoLogi
public Integer getIntentosLogin() { return intentosLogin; }
public void setIntentosLogin(Integer intentosLogin) { this.intentosLogin = intentosLo
public LocalDateTime getCreatedAt() { return createdAt; }
public LocalDateTime getUpdatedAt() { return updatedAt; }
public LocalDateTime getDeletedAt() { return deletedAt; }
public void setDeletedAt(LocalDateTime deletedAt) { this.deletedAt = deletedAt; }
// Métodos de utilidad
public String getNombreCompleto() {
return nombre + " " + apellido;
}
public boolean isActive() {
return activo && deletedAt == null;
}
public void incrementarIntentosLogin() {
this.intentosLogin++;
if (this.intentosLogin >= 5) {
this.activo = false;
}
}
public void resetIntentosLogin() {
this.intentosLogin = 0;
this.ultimoLogin = LocalDateTime.now();
}
// Enum interno
public enum RolUsuario {
ADMIN, COMPLIANCE_OFFICER, AUDITOR, USER
}
}
// model/Auditoria.java (Entidad completa similar)
package com.compliancebot.model;
import jakarta.persistence.*;
import jakarta.validation.constraints.*;

import org.hibernate.annotations.CreationTimestamp;
import org.hibernate.annotations.UpdateTimestamp;
import org.hibernate.annotations.Where;
import java.math.BigDecimal;
import java.time.LocalDate;
import java.time.LocalDateTime;
import java.util.List;
@Entity
@Table(name = "auditorias")
@Where(clause = "deleted_at IS NULL")
public class Auditoria {
@Id
@GeneratedValue(strategy = GenerationType.IDENTITY)
private Long id;
@ManyToOne(fetch = FetchType.LAZY)
@JoinColumn(name = "empresa_id", nullable = false)
private Empresa empresa;
@ManyToOne(fetch = FetchType.LAZY)
@JoinColumn(name = "framework_id")
private Framework framework;
@NotBlank(message = "El nombre de la auditoría es obligatorio")
@Size(max = 255)
@Column(name = "nombre", nullable = false)
private String nombre;
@Column(name = "descripcion", columnDefinition = "TEXT")
private String descripcion;
@NotNull(message = "El tipo de auditoría es obligatorio")
@Enumerated(EnumType.STRING)
@Column(name = "tipo", nullable = false)
private TipoAuditoria tipo;
@Enumerated(EnumType.STRING)
@Column(name = "estado")
private EstadoAuditoria estado = EstadoAuditoria.PLANIFICADA;
@ManyToOne(fetch = FetchType.LAZY)
@JoinColumn(name = "auditor_principal_id")
private Usuario auditorPrincipal;
@Column(name = "auditor_externo")
private String auditorExterno;
@Column(name = "fecha_inicio")
private LocalDate fechaInicio;
@Column(name = "fecha_fin")
private LocalDate fechaFin;

@Column(name = "fecha_planificada")
private LocalDate fechaPlanificada;
@DecimalMin(value = "0.0", message = "El score final debe ser mayor o igual a 0")
@DecimalMax(value = "100.0", message = "El score final debe ser menor o igual a 100")
@Column(name = "score_final", precision = 5, scale = 2)
private BigDecimal scoreFinal;
@Min(value = 0, message = "Los hallazgos críticos no pueden ser negativos")
@Column(name = "hallazgos_criticos")
private Integer hallazgosCriticos = 0;
@Min(value = 0, message = "Los hallazgos mayores no pueden ser negativos")
@Column(name = "hallazgos_mayores")
private Integer hallazgosMayores = 0;
@Min(value = 0, message = "Los hallazgos menores no pueden ser negativos")
@Column(name = "hallazgos_menores")
private Integer hallazgosMenores = 0;
@Column(name = "observaciones", columnDefinition = "TEXT")
private String observaciones;
@CreationTimestamp
@Column(name = "created_at", nullable = false, updatable = false)
private LocalDateTime createdAt;
@UpdateTimestamp
@Column(name = "updated_at")
private LocalDateTime updatedAt;
@Column(name = "deleted_at")
private LocalDateTime deletedAt;
// Relaciones
@OneToMany(mappedBy = "auditoria", cascade = CascadeType.ALL, fetch = FetchType.LAZY)
private List<Politica> politicas;
@OneToMany(mappedBy = "auditoria", cascade = CascadeType.ALL, fetch = FetchType.LAZY)
private List<Riesgo> riesgos;
@OneToMany(mappedBy = "auditoria", cascade = CascadeType.ALL, fetch = FetchType.LAZY)
private List<Reporte> reportes;
// Constructores
public Auditoria() {}
public Auditoria(String nombre, TipoAuditoria tipo, Empresa empresa, Framework framew
this.nombre = nombre;
this.tipo = tipo;
this.empresa = empresa;
this.framework = framework;
}
// Getters y Setters completos...
// [Implementar todos los getters y setters]

// Métodos de utilidad
public boolean isCompletada() {
return estado == EstadoAuditoria.COMPLETADA;
}
public boolean isEnProgreso() {
return estado == EstadoAuditoria.EN_PROGRESO;
}
public Integer getTotalHallazgos() {
return (hallazgosCriticos != null ? hallazgosCriticos : 0) +
(hallazgosMayores != null ? hallazgosMayores : 0) +
(hallazgosMenores != null ? hallazgosMenores : 0);

}
public String getNivelRiesgoGeneral() {
if (hallazgosCriticos != null && hallazgosCriticos > 0) {
return "CRÍTICO";
} else if (hallazgosMayores != null && hallazgosMayores > 2) {
return "ALTO";
} else if (getTotalHallazgos() > 5) {
return "MEDIO";
} else {
return "BAJO";
}
}
// Enums internos
public enum TipoAuditoria {
INTERNA, EXTERNA, MOCK, CONTINUA
}
public enum EstadoAuditoria {
PLANIFICADA, EN_PROGRESO, COMPLETADA, CANCELADA
}
}
// model/Framework.java, model/Politica.java, model/Riesgo.java, model/Documento.java, mo
// [Implementar de manera similar con validaciones, relaciones y métodos de utilidad]

// repository/EmpresaRepository.java
package com.compliancebot.repository;
import com.compliancebot.model.Empresa;
import org.springframework.data.domain.Page;
import org.springframework.data.domain.Pageable;
import org.springframework.data.jpa.repository.JpaRepository;
import org.springframework.data.jpa.repository.Query;
import org.springframework.data.repository.query.Param;
import org.springframework.stereotype.Repository;
import java.util.List;
3.3 Repositories JPA

import java.util.Optional;
@Repository
public interface EmpresaRepository extends JpaRepository<Empresa, Long> {
// Buscar por RUT
Optional<Empresa> findByRutAndDeletedAtIsNull(String rut);
// Buscar por industria
List<Empresa> findByIndustriaAndDeletedAtIsNull(String industria);
// Buscar por rango de empleados
List<Empresa> findByNumEmpleadosBetweenAndDeletedAtIsNull(Integer minEmpleados, Integ
// Buscar por ubicación
List<Empresa> findByUbicacionContainingIgnoreCaseAndDeletedAtIsNull(String ubicacion)
// Buscar por estado
List<Empresa> findByStatusAndDeletedAtIsNull(Empresa.StatusEmpresa status);
// Query personalizada para buscar empresas con auditorías pendientes
@Query("SELECT e FROM Empresa e JOIN e.auditorias a " +
"WHERE a.estado = 'PLANIFICADA' AND e.deletedAt IS NULL " +
"GROUP BY e ORDER BY COUNT(a) DESC")
List<Empresa> findEmpresasConAuditoriasPendientes();
// Query para estadísticas por industria
@Query("SELECT e.industria, COUNT(e) FROM Empresa e " +
"WHERE e.deletedAt IS NULL GROUP BY e.industria")
List<Object[]> getEstadisticasPorIndustria();
// Búsqueda paginada
Page<Empresa> findByDeletedAtIsNull(Pageable pageable);
// Búsqueda con filtros múltiples
@Query("SELECT e FROM Empresa e WHERE " +
"(:industria IS NULL OR e.industria = :industria) AND " +
"(:minEmpleados IS NULL OR e.numEmpleados >= :minEmpleados) AND " +
"(:maxEmpleados IS NULL OR e.numEmpleados <= :maxEmpleados) AND " +
"(:ubicacion IS NULL OR LOWER(e.ubicacion) LIKE LOWER(CONCAT('%', :ubicacion,
"e.deletedAt IS NULL")
Page<Empresa> findWithFilters(@Param("industria") String industria,
@Param("minEmpleados") Integer minEmpleados,
@Param("maxEmpleados") Integer maxEmpleados,
@Param("ubicacion") String ubicacion,
Pageable pageable);

// Verificar si existe RUT
boolean existsByRutAndDeletedAtIsNull(String rut);
// Contar empresas activas
long countByStatusAndDeletedAtIsNull(Empresa.StatusEmpresa status);
}
// repository/AuditoriaRepository.java
package com.compliancebot.repository;

import com.compliancebot.model.Auditoria;
import org.springframework.data.domain.Page;
import org.springframework.data.domain.Pageable;
import org.springframework.data.jpa.repository.JpaRepository;
import org.springframework.data.jpa.repository.Query;
import org.springframework.data.repository.query.Param;
import org.springframework.stereotype.Repository;
import java.time.LocalDate;
import java.util.List;
@Repository
public interface AuditoriaRepository extends JpaRepository<Auditoria, Long> {
// Buscar por empresa
List<Auditoria> findByEmpresaIdAndDeletedAtIsNull(Long empresaId);
// Buscar por estado
List<Auditoria> findByEstadoAndDeletedAtIsNull(Auditoria.EstadoAuditoria estado);
// Buscar por tipo
List<Auditoria> findByTipoAndDeletedAtIsNull(Auditoria.TipoAuditoria tipo);
// Buscar por auditor principal
List<Auditoria> findByAuditorPrincipalIdAndDeletedAtIsNull(Long auditorId);
// Buscar por rango de fechas
List<Auditoria> findByFechaPlanificadaBetweenAndDeletedAtIsNull(LocalDate fechaInicio
// Query para auditorías vencidas
@Query("SELECT a FROM Auditoria a WHERE " +
"a.fechaPlanificada < CURRENT_DATE AND " +
"a.estado IN ('PLANIFICADA', 'EN_PROGRESO') AND " +
"a.deletedAt IS NULL")
List<Auditoria> findAuditoriasVencidas();
// Auditorías próximas a vencer (próximos 7 días)
@Query("SELECT a FROM Auditoria a WHERE " +
"a.fechaPlanificada BETWEEN CURRENT_DATE AND :fechaLimite AND " +
"a.estado = 'PLANIFICADA' AND " +
"a.deletedAt IS NULL")
List<Auditoria> findAuditoriasProximasAVencer(@Param("fechaLimite") LocalDate fechaLi
// Estadísticas de auditorías por empresa
@Query("SELECT a.empresa.id, a.estado, COUNT(a) FROM Auditoria a " +
"WHERE a.deletedAt IS NULL GROUP BY a.empresa.id, a.estado")
List<Object[]> getEstadisticasAuditoriasPorEmpresa();
// Promedio de score por tipo de auditoría
@Query("SELECT a.tipo, AVG(a.scoreFinal) FROM Auditoria a " +
"WHERE a.scoreFinal IS NOT NULL AND a.deletedAt IS NULL " +
"GROUP BY a.tipo")
List<Object[]> getPromedioScorePorTipo();
// Buscar con múltiples filtros

@Query("SELECT a FROM Auditoria a WHERE " +
"(:empresaId IS NULL OR a.empresa.id = :empresaId) AND " +
"(:estado IS NULL OR a.estado = :estado) AND " +
"(:tipo IS NULL OR a.tipo = :tipo) AND " +
"(:fechaInicio IS NULL OR a.fechaPlanificada >= :fechaInicio) AND " +
"(:fechaFin IS NULL OR a.fechaPlanificada <= :fechaFin) AND " +
"a.deletedAt IS NULL")
Page<Auditoria> findWithFilters(@Param("empresaId") Long empresaId,

@Param("estado") Auditoria.EstadoAuditoria estado,
@Param("tipo") Auditoria.TipoAuditoria tipo,
@Param("fechaInicio") LocalDate fechaInicio,
@Param("fechaFin") LocalDate fechaFin,
Pageable pageable);

}
// repository/UsuarioRepository.java, PoliticaRepository.java, RiesgoRepository.java, etc
// [Implementar de manera similar]

// service/EmpresaService.java
package com.compliancebot.service;
import com.compliancebot.dto.request.CreateEmpresaRequest;
import com.compliancebot.dto.request.UpdateEmpresaRequest;
import com.compliancebot.dto.response.EmpresaResponse;
import com.compliancebot.exception.ResourceNotFoundException;
import com.compliancebot.exception.BusinessValidationException;
import com.compliancebot.model.Empresa;
import com.compliancebot.repository.EmpresaRepository;
import com.compliancebot.validation.ValidatorUtils;
import org.modelmapper.ModelMapper;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.data.domain.Page;
import org.springframework.data.domain.Pageable;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;
import java.time.LocalDateTime;
import java.util.List;
import java.util.stream.Collectors;
@Service
@Transactional
public class EmpresaService {
private static final Logger logger = LoggerFactory.getLogger(EmpresaService.class);
@Autowired
private EmpresaRepository empresaRepository;
@Autowired
private ModelMapper modelMapper;
3.4 Servicios con Lógica de Negocio

@Autowired
private ValidatorUtils validatorUtils;
/**
* Crear nueva empresa con validaciones de negocio
*/
public EmpresaResponse createEmpresa(CreateEmpresaRequest request) {
logger.info("Creando nueva empresa: {}", request.getNombre());
// Validaciones de negocio
validateCreateEmpresaRequest(request);
// Verificar que el RUT no exista
if (empresaRepository.existsByRutAndDeletedAtIsNull(request.getRut())) {
throw new BusinessValidationException("Ya existe una empresa con el RUT: " +
}
// Crear entidad
Empresa empresa = modelMapper.map(request, Empresa.class);
empresa.setStatus(Empresa.StatusEmpresa.ACTIVE);
// Validar RUT chileno
if (!validatorUtils.isValidChileanRut(request.getRut())) {
throw new BusinessValidationException("RUT chileno inválido: " + request.getR
}
// Guardar
empresa = empresaRepository.save(empresa);
logger.info("Empresa creada exitosamente con ID: {}", empresa.getId());
return modelMapper.map(empresa, EmpresaResponse.class);
}
/**
* Obtener empresa por ID
*/
@Transactional(readOnly = true)
public EmpresaResponse getEmpresaById(Long id) {
logger.debug("Buscando empresa con ID: {}", id);
Empresa empresa = empresaRepository.findById(id)
.filter(e -> e.getDeletedAt() == null)
.orElseThrow(() -> new ResourceNotFoundException("Empresa no encontrada con I
return modelMapper.map(empresa, EmpresaResponse.class);
}
/**
* Obtener todas las empresas con paginación
*/
@Transactional(readOnly = true)
public Page<EmpresaResponse> getAllEmpresas(Pageable pageable) {
logger.debug("Obteniendo todas las empresas - página: {}, tamaño: {}",
pageable.getPageNumber(), pageable.getPageSize());

Page<Empresa> empresas = empresaRepository.findByDeletedAtIsNull(pageable);
return empresas.map(empresa -> modelMapper.map(empresa, EmpresaResponse.class));
}
/**
* Buscar empresas con filtros
*/
@Transactional(readOnly = true)
public Page<EmpresaResponse> searchEmpresas(String industria, Integer minEmpleados,
Integer maxEmpleados, String ubicacion,
Pageable pageable) {

logger.debug("Buscando empresas con filtros - industria: {}, empleados: {}-{}, ub

industria, minEmpleados, maxEmpleados, ubicacion);
Page<Empresa> empresas = empresaRepository.findWithFilters(
industria, minEmpleados, maxEmpleados, ubicacion, pageable
);
return empresas.map(empresa -> modelMapper.map(empresa, EmpresaResponse.class));
}
/**
* Actualizar empresa
*/
public EmpresaResponse updateEmpresa(Long id, UpdateEmpresaRequest request) {
logger.info("Actualizando empresa con ID: {}", id);
Empresa empresa = empresaRepository.findById(id)
.filter(e -> e.getDeletedAt() == null)
.orElseThrow(() -> new ResourceNotFoundException("Empresa no encontrada con I
// Validaciones de negocio para actualización
validateUpdateEmpresaRequest(id, request);
// Actualizar campos
if (request.getNombre() != null) {
empresa.setNombre(request.getNombre());
}
if (request.getIndustria() != null) {
empresa.setIndustria(request.getIndustria());
}
if (request.getNumEmpleados() != null) {
empresa.setNumEmpleados(request.getNumEmpleados());
}
if (request.getUbicacion() != null) {
empresa.setUbicacion(request.getUbicacion());
}
if (request.getTelefono() != null) {
empresa.setTelefono(request.getTelefono());
}
if (request.getEmail() != null) {
empresa.setEmail(request.getEmail());
}
if (request.getDescripcion() != null) {

empresa.setDescripcion(request.getDescripcion());
}
empresa = empresaRepository.save(empresa);
logger.info("Empresa actualizada exitosamente: {}", empresa.getId());
return modelMapper.map(empresa, EmpresaResponse.class);
}
/**
* Eliminar empresa (soft delete)
*/
public void deleteEmpresa(Long id) {
logger.info("Eliminando empresa con ID: {}", id);
Empresa empresa = empresaRepository.findById(id)
.filter(e -> e.getDeletedAt() == null)
.orElseThrow(() -> new ResourceNotFoundException("Empresa no encontrada con I
// Validar que no tenga auditorías en progreso
boolean tieneAuditoriasActivas = empresa.getAuditorias().stream()
.anyMatch(audit -> audit.getEstado() == Auditoria.EstadoAuditoria.EN_PROGRESO
if (tieneAuditoriasActivas) {
throw new BusinessValidationException("No se puede eliminar la empresa. Tiene
}
// Soft delete
empresa.softDelete();
empresaRepository.save(empresa);
logger.info("Empresa eliminada exitosamente: {}", id);
}
/**
* Obtener estadísticas de empresas
*/
@Transactional(readOnly = true)
public List<Object[]> getEstadisticasPorIndustria() {
return empresaRepository.getEstadisticasPorIndustria();
}
/**
* Obtener empresas por industria
*/
@Transactional(readOnly = true)
public List<EmpresaResponse> getEmpresasPorIndustria(String industria) {
logger.debug("Buscando empresas por industria: {}", industria);
List<Empresa> empresas = empresaRepository.findByIndustriaAndDeletedAtIsNull(indu
return empresas.stream()
.map(empresa -> modelMapper.map(empresa, EmpresaResponse.class))
.collect(Collectors.toList());
}

// Métodos de validación privados
private void validateCreateEmpresaRequest(CreateEmpresaRequest request) {
if (request.getNombre() == null || request.getNombre().trim().isEmpty()) {
throw new BusinessValidationException("El nombre de la empresa es obligatorio
}
if (request.getRut() == null || request.getRut().trim().isEmpty()) {
throw new BusinessValidationException("El RUT es obligatorio");
}
if (request.getNumEmpleados() == null || request.getNumEmpleados() <= 0) {
throw new BusinessValidationException("El número de empleados debe ser mayor
}
if (request.getNumEmpleados() > 10000) {
throw new BusinessValidationException("El número de empleados no puede ser ma
}
// Validar industria permitida
List<String> industriasPermitidas = List.of("restaurante", "cafeteria", "panaderi
"retail", "servicios", "manufactura");
if (!industriasPermitidas.contains(request.getIndustria().toLowerCase())) {
throw new BusinessValidationException("Industria no válida: " + request.getIn
}
}
private void validateUpdateEmpresaRequest(Long empresaId, UpdateEmpresaRequest reques
// Si se está actualizando el RUT, verificar que no exista en otra empresa
if (request.getRut() != null) {
empresaRepository.findByRutAndDeletedAtIsNull(request.getRut())
.ifPresent(empresa -> {
if (!empresa.getId().equals(empresaId)) {
throw new BusinessValidationException("Ya existe otra empresa con
}
});
if (!validatorUtils.isValidChileanRut(request.getRut())) {
throw new BusinessValidationException("RUT chileno inválido: " + request.
}
}
if (request.getNumEmpleados() != null && request.getNumEmpleados() <= 0) {
throw new BusinessValidationException("El número de empleados debe ser mayor
}
}
}
// service/AuditoriaService.java
package com.compliancebot.service;
import com.compliancebot.dto.request.CreateAuditoriaRequest;
import com.compliancebot.dto.response.AuditoriaResponse;
import com.compliancebot.exception.ResourceNotFoundException;
import com.compliancebot.exception.BusinessValidationException;
import com.compliancebot.model.Auditoria;

import com.compliancebot.model.Empresa;
import com.compliancebot.model.Usuario;
import com.compliancebot.repository.AuditoriaRepository;
import com.compliancebot.repository.EmpresaRepository;
import com.compliancebot.repository.UsuarioRepository;
import org.modelmapper.ModelMapper;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.data.domain.Page;
import org.springframework.data.domain.Pageable;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;
import java.time.LocalDate;
import java.util.List;
import java.util.stream.Collectors;
@Service
@Transactional
public class AuditoriaService {
private static final Logger logger = LoggerFactory.getLogger(AuditoriaService.class);
@Autowired
private AuditoriaRepository auditoriaRepository;
@Autowired
private EmpresaRepository empresaRepository;
@Autowired
private UsuarioRepository usuarioRepository;
@Autowired
private ModelMapper modelMapper;
/**
* Crear nueva auditoría
*/
public AuditoriaResponse createAuditoria(CreateAuditoriaRequest request) {
logger.info("Creando nueva auditoría: {}", request.getNombre());
// Validar empresa existe
Empresa empresa = empresaRepository.findById(request.getEmpresaId())
.filter(e -> e.getDeletedAt() == null)
.orElseThrow(() -> new ResourceNotFoundException("Empresa no encontrada: " +
// Validar auditor si se especifica
Usuario auditor = null;
if (request.getAuditorPrincipalId() != null) {
auditor = usuarioRepository.findById(request.getAuditorPrincipalId())
.filter(u -> u.getDeletedAt() == null && u.isActive())
.orElseThrow(() -> new ResourceNotFoundException("Auditor no encontrado:
// Verificar que el auditor pertenezca a la empresa
if (!auditor.getEmpresa().getId().equals(request.getEmpresaId())) {

throw new BusinessValidationException("El auditor no pertenece a la empre
}
}
// Validaciones de negocio
validateCreateAuditoriaRequest(request, empresa);
// Crear entidad
Auditoria auditoria = new Auditoria();
auditoria.setNombre(request.getNombre());
auditoria.setDescripcion(request.getDescripcion());
auditoria.setTipo(request.getTipo());
auditoria.setEmpresa(empresa);
auditoria.setAuditorPrincipal(auditor);
auditoria.setAuditorExterno(request.getAuditorExterno());
auditoria.setFechaPlanificada(request.getFechaPlanificada());
auditoria.setEstado(Auditoria.EstadoAuditoria.PLANIFICADA);
auditoria = auditoriaRepository.save(auditoria);
logger.info("Auditoría creada exitosamente con ID: {}", auditoria.getId());
return modelMapper.map(auditoria, AuditoriaResponse.class);
}
/**
* Iniciar auditoría
*/
public AuditoriaResponse iniciarAuditoria(Long id) {
logger.info("Iniciando auditoría con ID: {}", id);
Auditoria auditoria = auditoriaRepository.findById(id)
.filter(a -> a.getDeletedAt() == null)
.orElseThrow(() -> new ResourceNotFoundException("Auditoría no encontrada: "
// Validar que esté en estado planificada
if (auditoria.getEstado() != Auditoria.EstadoAuditoria.PLANIFICADA) {
throw new BusinessValidationException("Solo se pueden iniciar auditorías en e
}
// Validar fecha
if (auditoria.getFechaPlanificada() != null && auditoria.getFechaPlanificada().is
throw new BusinessValidationException("No se puede iniciar una auditoría ante
}
auditoria.setEstado(Auditoria.EstadoAuditoria.EN_PROGRESO);
auditoria.setFechaInicio(LocalDate.now());
auditoria = auditoriaRepository.save(auditoria);
logger.info("Auditoría iniciada exitosamente: {}", id);
return modelMapper.map(auditoria, AuditoriaResponse.class);
}
/**

* Completar auditoría
*/
public AuditoriaResponse completarAuditoria(Long id, CompletarAuditoriaRequest reques
logger.info("Completando auditoría con ID: {}", id);
Auditoria auditoria = auditoriaRepository.findById(id)
.filter(a -> a.getDeletedAt() == null)
.orElseThrow(() -> new ResourceNotFoundException("Auditoría no encontrada: "
// Validar que esté en progreso
if (auditoria.getEstado() != Auditoria.EstadoAuditoria.EN_PROGRESO) {
throw new BusinessValidationException("Solo se pueden completar auditorías en
}
// Actualizar datos finales
auditoria.setEstado(Auditoria.EstadoAuditoria.COMPLETADA);
auditoria.setFechaFin(LocalDate.now());
auditoria.setScoreFinal(request.getScoreFinal());
auditoria.setHallazgosCriticos(request.getHallazgosCriticos());
auditoria.setHallazgosMayores(request.getHallazgosMayores());
auditoria.setHallazgosMenores(request.getHallazgosMenores());
auditoria.setObservaciones(request.getObservaciones());
auditoria = auditoriaRepository.save(auditoria);
logger.info("Auditoría completada exitosamente: {}", id);
return modelMapper.map(auditoria, AuditoriaResponse.class);
}
/**
* Obtener auditorías por empresa
*/
@Transactional(readOnly = true)
public List<AuditoriaResponse> getAuditoriasByEmpresa(Long empresaId) {
List<Auditoria> auditorias = auditoriaRepository.findByEmpresaIdAndDeletedAtIsNul
return auditorias.stream()
.map(auditoria -> modelMapper.map(auditoria, AuditoriaResponse.class))
.collect(Collectors.toList());
}
/**
* Obtener auditorías vencidas
*/
@Transactional(readOnly = true)
public List<AuditoriaResponse> getAuditoriasVencidas() {
List<Auditoria> auditorias = auditoriaRepository.findAuditoriasVencidas();
return auditorias.stream()
.map(auditoria -> modelMapper.map(auditoria, AuditoriaResponse.class))
.collect(Collectors.toList());
}
// Métodos de validación privados
private void validateCreateAuditoriaRequest(CreateAuditoriaRequest request, Empresa e

// Verificar que no exista una auditoría con el mismo nombre en la empresa
List<Auditoria> auditoriasExistentes = auditoriaRepository.findByEmpresaIdAndDele
boolean nombreExiste = auditoriasExistentes.stream()
.anyMatch(a -> a.getNombre().equalsIgnoreCase(request.getNombre()));
if (nombreExiste) {
throw new BusinessValidationException("Ya existe una auditoría con el nombre:
}
// Validar fecha planificada
if (request.getFechaPlanificada() != null && request.getFechaPlanificada().isBefo
throw new BusinessValidationException("La fecha planificada no puede ser en e
}
// Validar tipo de auditoría vs capacidad de la empresa
if (request.getTipo() == Auditoria.TipoAuditoria.EXTERNA && empresa.getNumEmplead
logger.warn("Empresa pequeña ({} empleados) solicitando auditoría externa", e
}
}
}

// controller/EmpresaController.java
package com.compliancebot.controller;
import com.compliancebot.dto.request.CreateEmpresaRequest;
import com.compliancebot.dto.request.UpdateEmpresaRequest;
import com.compliancebot.dto.response.ApiResponse;
import com.compliancebot.dto.response.EmpresaResponse;
import com.compliancebot.service.EmpresaService;
import io.swagger.v3.oas.annotations.Operation;
import io.swagger.v3.oas.annotations.Parameter;
import io.swagger.v3.oas.annotations.responses.ApiResponses;
import io.swagger.v3.oas.annotations.responses.ApiResponse as SwaggerApiResponse;
import io.swagger.v3.oas.annotations.tags.Tag;
import jakarta.validation.Valid;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.data.domain.Page;
import org.springframework.data.domain.Pageable;
import org.springframework.data.web.PageableDefault;
import org.springframework.http.HttpStatus;
import org.springframework.http.ResponseEntity;
import org.springframework.web.bind.annotation.*;
import java.util.List;
@RestController
@RequestMapping("/empresas")
@Tag(name = "Empresas", description = "Gestión de empresas del sistema")
@CrossOrigin(origins = "*")
public class EmpresaController {
3.5 Controladores REST (8+ Endpoints)

private static final Logger logger = LoggerFactory.getLogger(EmpresaController.class)
@Autowired
private EmpresaService empresaService;
@PostMapping
@Operation(summary = "Crear nueva empresa", description = "Crea una nueva empresa en
@ApiResponses(value = {
@SwaggerApiResponse(responseCode = "201", description = "Empresa creada exitosame
@SwaggerApiResponse(responseCode = "400", description = "Datos de entrada inválid
@SwaggerApiResponse(responseCode = "409", description = "Empresa ya existe (RUT d
})
public ResponseEntity<ApiResponse<EmpresaResponse>> createEmpresa(
@Valid @RequestBody CreateEmpresaRequest request) {
logger.info("POST /empresas - Creando empresa: {}", request.getNombre());
EmpresaResponse empresa = empresaService.createEmpresa(request);
ApiResponse<EmpresaResponse> response = ApiResponse.success(
empresa, "Empresa creada exitosamente"
);
return new ResponseEntity<>(response, HttpStatus.CREATED);
}
@GetMapping("/{id}")
@Operation(summary = "Obtener empresa por ID", description = "Obtiene los datos de un
public ResponseEntity<ApiResponse<EmpresaResponse>> getEmpresaById(
@Parameter(description = "ID de la empresa") @PathVariable Long id) {
logger.info("GET /empresas/{} - Obteniendo empresa", id);
EmpresaResponse empresa = empresaService.getEmpresaById(id);
ApiResponse<EmpresaResponse> response = ApiResponse.success(empresa);
return ResponseEntity.ok(response);
}
@GetMapping
@Operation(summary = "Obtener todas las empresas", description = "Obtiene listado pag
public ResponseEntity<ApiResponse<Page<EmpresaResponse>>> getAllEmpresas(
@PageableDefault(size = 20) Pageable pageable) {
logger.info("GET /empresas - Obteniendo empresas (página: {}, tamaño: {})",

pageable.getPageNumber(), pageable.getPageSize());

Page<EmpresaResponse> empresas = empresaService.getAllEmpresas(pageable);
ApiResponse<Page<EmpresaResponse>> response = ApiResponse.success(
empresas, String.format("Se encontraron %d empresas", empresas.getTotalElemen
);
return ResponseEntity.ok(response);
}

@GetMapping("/search")
@Operation(summary = "Buscar empresas", description = "Busca empresas con filtros opc
public ResponseEntity<ApiResponse<Page<EmpresaResponse>>> searchEmpresas(
@Parameter(description = "Filtrar por industria") @RequestParam(required = fa
@Parameter(description = "Mínimo número de empleados") @RequestParam(required
@Parameter(description = "Máximo número de empleados") @RequestParam(required
@Parameter(description = "Filtrar por ubicación") @RequestParam(required = fa
@PageableDefault(size = 20) Pageable pageable) {
logger.info("GET /empresas/search - Buscando con filtros: industria={}, empleados

industria, minEmpleados, maxEmpleados, ubicacion);
Page<EmpresaResponse> empresas = empresaService.searchEmpresas(
industria, minEmpleados, maxEmpleados, ubicacion, pageable
);
ApiResponse<Page<EmpresaResponse>> response = ApiResponse.success(
empresas, String.format("Se encontraron %d empresas", empresas.getTotalElemen
);
return ResponseEntity.ok(response);
}
@PutMapping("/{id}")
@Operation(summary = "Actualizar empresa", description = "Actualiza los datos de una
public ResponseEntity<ApiResponse<EmpresaResponse>> updateEmpresa(
@Parameter(description = "ID de la empresa") @PathVariable Long id,
@Valid @RequestBody UpdateEmpresaRequest request) {
logger.info("PUT /empresas/{} - Actualizando empresa", id);
EmpresaResponse empresa = empresaService.updateEmpresa(id, request);
ApiResponse<EmpresaResponse> response = ApiResponse.success(
empresa, "Empresa actualizada exitosamente"
);
return ResponseEntity.ok(response);
}
@DeleteMapping("/{id}")
@Operation(summary = "Eliminar empresa", description = "Elimina una empresa del siste
public ResponseEntity<ApiResponse<Void>> deleteEmpresa(
@Parameter(description = "ID de la empresa") @PathVariable Long id) {
logger.info("DELETE /empresas/{} - Eliminando empresa", id);
empresaService.deleteEmpresa(id);
ApiResponse<Void> response = ApiResponse.success(null, "Empresa eliminada exitosa
return ResponseEntity.ok(response);
}
@GetMapping("/industria/{industria}")

@Operation(summary = "Obtener empresas por industria")
public ResponseEntity<ApiResponse<List<EmpresaResponse>>> getEmpresasPorIndustria(
@Parameter(description = "Nombre de la industria") @PathVariable String indus
logger.info("GET /empresas/industria/{} - Obteniendo empresas por industria", ind
List<EmpresaResponse> empresas = empresaService.getEmpresasPorIndustria(industria
ApiResponse<List<EmpresaResponse>> response = ApiResponse.success(
empresas, String.format("Se encontraron %d empresas en la industria %s",

empresas.size(), industria)

);
return ResponseEntity.ok(response);
}
@GetMapping("/estadisticas/industria")
@Operation(summary = "Estadísticas por industria")
public ResponseEntity<ApiResponse<List<Object[]>>> getEstadisticasPorIndustria() {
logger.info("GET /empresas/estadisticas/industria - Obteniendo estadísticas");
List<Object[]> estadisticas = empresaService.getEstadisticasPorIndustria();
ApiResponse<List<Object[]>> response = ApiResponse.success(
estadisticas, "Estadísticas obtenidas exitosamente"
);
return ResponseEntity.ok(response);
}
}
// controller/AuditoriaController.java (Similar structure)
@RestController
@RequestMapping("/auditorias")
@Tag(name = "Auditorías", description = "Gestión de auditorías de compliance")
public class AuditoriaController {
// Implementar endpoints similares para auditorías
// POST /auditorias - Crear auditoría
// GET /auditorias/{id} - Obtener auditoría
// GET /auditorias - Listar auditorías
// PUT /auditorias/{id}/iniciar - Iniciar auditoría
// PUT /auditorias/{id}/completar - Completar auditoría
// DELETE /auditorias/{id} - Eliminar auditoría
// GET /auditorias/empresa/{empresaId} - Auditorías por empresa
// GET /auditorias/vencidas - Auditorías vencidas
}
// controller/PoliticaController.java, RiesgoController.java, etc.
// [Implementar controladores similares para las demás entidades]

// dto/request/CreateEmpresaRequest.java
package com.compliancebot.dto.request;
import jakarta.validation.constraints.*;
import io.swagger.v3.oas.annotations.media.Schema;
import java.time.LocalDate;
@Schema(description = "Datos para crear una nueva empresa")
public class CreateEmpresaRequest {
@NotBlank(message = "El nombre es obligatorio")
@Size(max = 255, message = "El nombre no puede exceder 255 caracteres")
@Schema(description = "Nombre de la empresa", example = "Restaurante El Buen Sabor")
private String nombre;
@NotBlank(message = "El RUT es obligatorio")
@Pattern(regexp = "^[0-9]{7,8}-[0-9Kk]$", message = "Formato de RUT inválido (ej: 123
@Schema(description = "RUT de la empresa", example = "76543210-9")
private String rut;
@NotBlank(message = "La industria es obligatoria")
@Schema(description = "Industria de la empresa", example = "restaurante",
allowableValues = {"restaurante", "cafeteria", "panaderia", "retail", "servic
private String industria;
@NotNull(message = "El número de empleados es obligatorio")
@Min(value = 1, message = "Debe tener al menos 1 empleado")
@Max(value = 10000, message = "Máximo 10,000 empleados")
@Schema(description = "Número de empleados", example = "15")
private Integer numEmpleados;
@NotBlank(message = "La ubicación es obligatoria")
@Size(max = 200)
@Schema(description = "Ubicación de la empresa", example = "Santiago, Chile")
private String ubicacion;
@Pattern(regexp = "^\\+?[0-9]{8,15}$", message = "Formato de teléfono inválido")
@Schema(description = "Teléfono de contacto", example = "+56912345678")
private String telefono;
@Email(message = "Email inválido")
@Schema(description = "Email de contacto", example = "contacto@empresa.cl")
private String email;
@Size(max = 1000, message = "La descripción no puede exceder 1000 caracteres")
@Schema(description = "Descripción de la empresa")
private String descripcion;
@Past(message = "La fecha de fundación debe ser en el pasado")
@Schema(description = "Fecha de fundación", example = "2020-01-15")
private LocalDate fechaFundacion;
// Constructores
3.6 DTOs para API

public CreateEmpresaRequest() {}
// Getters y Setters completos
public String getNombre() { return nombre; }
public void setNombre(String nombre) { this.nombre = nombre; }
public String getRut() { return rut; }
public void setRut(String rut) { this.rut = rut; }
public String getIndustria() { return industria; }
public void setIndustria(String industria) { this.industria = industria; }
public Integer getNumEmpleados() { return numEmpleados; }
public void setNumEmpleados(Integer numEmpleados) { this.numEmpleados = numEmpleados;
public String getUbicacion() { return ubicacion; }
public void setUbicacion(String ubicacion) { this.ubicacion = ubicacion; }
public String getTelefono() { return telefono; }
public void setTelefono(String telefono) { this.telefono = telefono; }
public String getEmail() { return email; }
public void setEmail(String email) { this.email = email; }
public String getDescripcion() { return descripcion; }
public void setDescripcion(String descripcion) { this.descripcion = descripcion; }
public LocalDate getFechaFundacion() { return fechaFundacion; }
public void setFechaFundacion(LocalDate fechaFundacion) { this.fechaFundacion = fecha
}
// dto/response/EmpresaResponse.java
package com.compliancebot.dto.response;
import io.swagger.v3.oas.annotations.media.Schema;
import java.time.LocalDate;
import java.time.LocalDateTime;
@Schema(description = "Datos de respuesta de empresa")
public class EmpresaResponse {
@Schema(description = "ID único de la empresa", example = "1")
private Long id;
@Schema(description = "Nombre de la empresa", example = "Restaurante El Buen Sabor")
private String nombre;
@Schema(description = "RUT de la empresa", example = "76543210-9")
private String rut;
@Schema(description = "Industria", example = "restaurante")
private String industria;
@Schema(description = "Número de empleados", example = "15")
private Integer numEmpleados;

@Schema(description = "Ubicación", example = "Santiago, Chile")
private String ubicacion;
@Schema(description = "Teléfono", example = "+56912345678")
private String telefono;
@Schema(description = "Email", example = "contacto@empresa.cl")
private String email;
@Schema(description = "Descripción")
private String descripcion;
@Schema(description = "Fecha de fundación")
private LocalDate fechaFundacion;
@Schema(description = "Estado", example = "ACTIVE")
private String status;
@Schema(description = "Fecha de creación")
private LocalDateTime createdAt;
@Schema(description = "Fecha de última actualización")
private LocalDateTime updatedAt;
// Constructores
public EmpresaResponse() {}
// Getters y Setters completos
// [Implementar todos los getters y setters]
}
// dto/response/ApiResponse.java - Wrapper genérico para respuestas
package com.compliancebot.dto.response;
import com.fasterxml.jackson.annotation.JsonInclude;
import io.swagger.v3.oas.annotations.media.Schema;
import java.time.LocalDateTime;
@JsonInclude(JsonInclude.Include.NON_NULL)
@Schema(description = "Respuesta estándar de la API")
public class ApiResponse<T> {
@Schema(description = "Indica si la operación fue exitosa", example = "true")
private boolean success;
@Schema(description = "Mensaje descriptivo")
private String message;
@Schema(description = "Datos de respuesta")
private T data;
@Schema(description = "Código de error (solo en caso de error)")
private String errorCode;
@Schema(description = "Timestamp de la respuesta")

private LocalDateTime timestamp;
// Constructores privados
private ApiResponse(boolean success, String message, T data, String errorCode) {
this.success = success;
this.message = message;
this.data = data;
this.errorCode = errorCode;
this.timestamp = LocalDateTime.now();
}
// Factory methods
public static <T> ApiResponse<T> success(T data) {
return new ApiResponse<>(true, "Operación exitosa", data, null);
}
public static <T> ApiResponse<T> success(T data, String message) {
return new ApiResponse<>(true, message, data, null);
}
public static <T> ApiResponse<T> error(String message) {
return new ApiResponse<>(false, message, null, null);
}
public static <T> ApiResponse<T> error(String message, String errorCode) {
return new ApiResponse<>(false, message, null, errorCode);
}
// Getters
public boolean isSuccess() { return success; }
public String getMessage() { return message; }
public T getData() { return data; }
public String getErrorCode() { return errorCode; }
public LocalDateTime getTimestamp() { return timestamp; }
}

# ml-service-python/app/main.py
from fastapi import FastAPI, HTTPException
from fastapi.middleware.cors import CORSMiddleware
from pydantic import BaseModel
from typing import List, Optional
import random
from datetime import datetime
app = FastAPI(title="ComplianceBot ML Service", version="1.0.0")
app.add_middleware(
CORSMiddleware,
allow_origins=["http://localhost:8080"],
allow_credentials=True,
allow_methods=["*"],
allow_headers=["*"],
)
3.7 Servicio ML Python Minimalista

# Schemas
class RiskAssessmentRequest(BaseModel):
empresa_id: int
nombre: str
industria: str
num_empleados: int
ubicacion: str
class RiskAssessmentResponse(BaseModel):
empresa_id: int
risk_level: str
confidence: float
recommendations: List[str]
risk_score: float
class DocumentGenerationRequest(BaseModel):
empresa_id: int
document_type: str
company_data: dict
class DocumentGenerationResponse(BaseModel):
empresa_id: int
document_type: str
content: str
compliance_score: float
# Endpoints
@app.get("/")
async def root():
return {"message": "ComplianceBot ML Service", "status": "running"}
@app.post("/assess-risk", response_model=RiskAssessmentResponse)
async def assess_risk(request: RiskAssessmentRequest):
"""Evalúa riesgo de compliance usando ML simplificado"""
try:
# Lógica simplificada de ML para demo
risk_score = calculate_risk_score(request)
risk_level = determine_risk_level(risk_score)
return RiskAssessmentResponse(
empresa_id=request.empresa_id,
risk_level=risk_level,
confidence=random.uniform(0.7, 0.95),
recommendations=generate_recommendations(risk_level, request.industria),
risk_score=risk_score
)
except Exception as e:
raise HTTPException(status_code=500, detail=str(e))
@app.post("/generate-document", response_model=DocumentGenerationResponse)
async def generate_document(request: DocumentGenerationRequest):
"""Genera documento de compliance"""
try:
content = generate_policy_content(request.company_data, request.document_type)
score = calculate_compliance_score(content)

return DocumentGenerationResponse(
empresa_id=request.empresa_id,
document_type=request.document_type,
content=content,
compliance_score=score
)
except Exception as e:
raise HTTPException(status_code=500, detail=str(e))
# Funciones auxiliares ML
def calculate_risk_score(request: RiskAssessmentRequest) -> float:
score = 50.0 # Base score
# Factor industria
industry_risk = {
'restaurante': 20, 'cafeteria': 15, 'panaderia': 18,
'retail': 10, 'servicios': 8
}
score += industry_risk.get(request.industria.lower(), 10)
# Factor empleados
if request.num_empleados > 50:
score += 10
elif request.num_empleados < 10:
score += 5
return min(max(score, 0), 100)
def determine_risk_level(score: float) -> str:
if score >= 70: return "ALTO"
elif score >= 50: return "MEDIO"
else: return "BAJO"
def generate_recommendations(risk_level: str, industria: str) -> List[str]:
base_recommendations = {
"ALTO": [
"Implementar plan de mejora inmediato",
"Realizar auditoría interna urgente",
"Capacitar personal en procedimientos críticos"
],
"MEDIO": [
"Desarrollar plan de mejora a 3 meses",
"Actualizar políticas y procedimientos",
"Capacitar personal en áreas identificadas"
],
"BAJO": [
"Mantener controles actuales",
"Revisión trimestral de políticas",
"Capacitación de refuerzo semestral"
]
}
recommendations = base_recommendations.get(risk_level, [])
if industria.lower() == 'restaurante':

recommendations.append("Implementar protocolos de higiene alimentaria")
return recommendations[:3]
def generate_policy_content(company_data: dict, document_type: str) -> str:
if document_type == "hygiene_policy":
return f"""# POLÍTICA DE HIGIENE ALIMENTARIA
**Empresa:** {company_data.get('name', 'Empresa')}
**Tipo:** {company_data.get('type', 'Establecimiento')}
## 1. OBJETIVO
Esta política establece los lineamientos para garantizar la higiene alimentaria.
## 2. PROCEDIMIENTOS
- Lavado de manos obligatorio cada 30 minutos
- Uso de guantes desechables
- Limpieza de superficies después de cada uso
## 3. RESPONSABILIDADES
- Gerencia: Supervisar cumplimiento
- Personal: Seguir protocolos establecidos
Generado automáticamente por ComplianceBot ML.
"""
else:
return f"Documento de tipo {document_type} generado para {company_data.get('name'
def calculate_compliance_score(content: str) -> float:
# Scoring simple basado en keywords
keywords = ['higiene', 'procedimiento', 'responsabilidad', 'control', 'monitoreo']
score = 60 # Base score
for keyword in keywords:
if keyword in content.lower():
score += 8
return min(score, 100)
if __name__ == "__main__":
import uvicorn
uvicorn.run(app, host="0.0.0.0", port=8001)

# ml-service-python/Dockerfile
FROM python:3.11-slim
WORKDIR /app
COPY requirements.txt .
RUN pip install --no-cache-dir -r requirements.txt
COPY . .
EXPOSE 8001

CMD ["uvicorn", "app.main:app", "--host", "0.0.0.0", "--port", "8001"]

# ml-service-python/requirements.txt
fastapi==0.104.1
uvicorn[standard]==0.24.0
pydantic==2.5.0

// src/test/java/com/compliancebot/service/EmpresaServiceTest.java
package com.compliancebot.service;
import com.compliancebot.dto.request.CreateEmpresaRequest;
import com.compliancebot.dto.response.EmpresaResponse;
import com.compliancebot.exception.BusinessValidationException;
import com.compliancebot.exception.ResourceNotFoundException;
import com.compliancebot.model.Empresa;
import com.compliancebot.repository.EmpresaRepository;
import com.compliancebot.validation.ValidatorUtils;
import org.junit.jupiter.api.BeforeEach;
import org.junit.jupiter.api.Test;
import org.junit.jupiter.api.extension.ExtendWith;
import org.mockito.InjectMocks;
import org.mockito.Mock;
import org.mockito.junit.jupiter.MockitoExtension;
import org.modelmapper.ModelMapper;
import java.util.Optional;
import static org.junit.jupiter.api.Assertions.*;
import static org.mockito.ArgumentMatchers.any;
import static org.mockito.ArgumentMatchers.anyString;
import static org.mockito.Mockito.*;
@ExtendWith(MockitoExtension.class)
class EmpresaServiceTest {
@Mock
private EmpresaRepository empresaRepository;
@Mock
private ModelMapper modelMapper;
@Mock
private ValidatorUtils validatorUtils;
@InjectMocks
private EmpresaService empresaService;
private CreateEmpresaRequest validRequest;
private Empresa empresa;
private EmpresaResponse empresaResponse;
3.8 Tests Unitarios

@BeforeEach
void setUp() {
validRequest = new CreateEmpresaRequest();
validRequest.setNombre("Test Restaurant");
validRequest.setRut("12345678-9");
validRequest.setIndustria("restaurante");
validRequest.setNumEmpleados(15);
validRequest.setUbicacion("Santiago, Chile");
empresa = new Empresa();
empresa.setId(1L);
empresa.setNombre("Test Restaurant");
empresa.setRut("12345678-9");
empresa.setIndustria("restaurante");
empresa.setNumEmpleados(15);
empresa.setUbicacion("Santiago, Chile");
empresaResponse = new EmpresaResponse();
empresaResponse.setId(1L);
empresaResponse.setNombre("Test Restaurant");
}
@Test
void createEmpresa_ValidRequest_Success() {
// Arrange
when(empresaRepository.existsByRutAndDeletedAtIsNull(anyString())).thenReturn(fal
when(validatorUtils.isValidChileanRut(anyString())).thenReturn(true);
when(modelMapper.map(validRequest, Empresa.class)).thenReturn(empresa);
when(empresaRepository.save(any(Empresa.class))).thenReturn(empresa);
when(modelMapper.map(empresa, EmpresaResponse.class)).thenReturn(empresaResponse)
// Act
EmpresaResponse result = empresaService.createEmpresa(validRequest);
// Assert
assertNotNull(result);
assertEquals("Test Restaurant", result.getNombre());
verify(empresaRepository).existsByRutAndDeletedAtIsNull("12345678-9");
verify(empresaRepository).save(any(Empresa.class));
}
@Test
void createEmpresa_DuplicateRut_ThrowsException() {
// Arrange
when(empresaRepository.existsByRutAndDeletedAtIsNull(anyString())).thenReturn(tru
// Act & Assert
BusinessValidationException exception = assertThrows(
BusinessValidationException.class,
() -> empresaService.createEmpresa(validRequest)
);
assertTrue(exception.getMessage().contains("Ya existe una empresa con el RUT"));
verify(empresaRepository, never()).save(any());
}

@Test
void createEmpresa_InvalidRut_ThrowsException() {
// Arrange
when(empresaRepository.existsByRutAndDeletedAtIsNull(anyString())).thenReturn(fal
when(validatorUtils.isValidChileanRut(anyString())).thenReturn(false);
when(modelMapper.map(validRequest, Empresa.class)).thenReturn(empresa);
// Act & Assert
BusinessValidationException exception = assertThrows(
BusinessValidationException.class,
() -> empresaService.createEmpresa(validRequest)
);
assertTrue(exception.getMessage().contains("RUT chileno inválido"));
}
@Test
void getEmpresaById_ExistingId_Success() {
// Arrange
when(empresaRepository.findById(1L)).thenReturn(Optional.of(empresa));
when(modelMapper.map(empresa, EmpresaResponse.class)).thenReturn(empresaResponse)
// Act
EmpresaResponse result = empresaService.getEmpresaById(1L);
// Assert
assertNotNull(result);
assertEquals(1L, result.getId());
verify(empresaRepository).findById(1L);
}
@Test
void getEmpresaById_NonExistingId_ThrowsException() {
// Arrange
when(empresaRepository.findById(999L)).thenReturn(Optional.empty());
// Act & Assert
ResourceNotFoundException exception = assertThrows(
ResourceNotFoundException.class,
() -> empresaService.getEmpresaById(999L)
);
assertTrue(exception.getMessage().contains("Empresa no encontrada"));
}
@Test
void createEmpresa_EmptyName_ThrowsException() {
// Arrange
validRequest.setNombre("");
// Act & Assert
BusinessValidationException exception = assertThrows(
BusinessValidationException.class,
() -> empresaService.createEmpresa(validRequest)
);

assertTrue(exception.getMessage().contains("nombre de la empresa es obligatorio")
}
@Test
void createEmpresa_NegativeEmployees_ThrowsException() {
// Arrange
validRequest.setNumEmpleados(-1);
// Act & Assert
BusinessValidationException exception = assertThrows(
BusinessValidationException.class,
() -> empresaService.createEmpresa(validRequest)
);
assertTrue(exception.getMessage().contains("número de empleados debe ser mayor a
}
@Test
void createEmpresa_InvalidIndustry_ThrowsException() {
// Arrange
validRequest.setIndustria("industria_invalida");
// Act & Assert
BusinessValidationException exception = assertThrows(
BusinessValidationException.class,
() -> empresaService.createEmpresa(validRequest)
);
assertTrue(exception.getMessage().contains("Industria no válida"));
}
}
// src/test/java/com/compliancebot/controller/EmpresaControllerTest.java
@SpringBootTest
@AutoConfigureTestDatabase(replace = AutoConfigureTestDatabase.Replace.NONE)
@TestMethodOrder(OrderAnnotation.class)
class EmpresaControllerIntegrationTest {
@Autowired
private TestRestTemplate restTemplate;
@Autowired
private EmpresaRepository empresaRepository;
@Test
@Order(1)
void createEmpresa_ValidRequest_ReturnsCreated() {
// Arrange
CreateEmpresaRequest request = new CreateEmpresaRequest();
request.setNombre("Integration Test Company");
request.setRut("11111111-1");
request.setIndustria("restaurante");
request.setNumEmpleados(10);
request.setUbicacion("Santiago, Chile");

// Act
ResponseEntity<ApiResponse> response = restTemplate.postForEntity(
"/api/v1/empresas", request, ApiResponse.class
);
// Assert
assertEquals(HttpStatus.CREATED, response.getStatusCode());
assertTrue(response.getBody().isSuccess());
}
// Más tests de integración...
}

# docker-compose.yml
version: '3.8'
services:
# PostgreSQL Database
postgres:
image: postgres:15-alpine
container_name: compliancebot-db
environment:
POSTGRES_DB: compliancebot
POSTGRES_USER: compliancebot
POSTGRES_PASSWORD: password123
POSTGRES_SCHEMA: compliancebot
ports:
- "5432:5432"
volumes:
- postgres_data:/var/lib/postgresql/data
- ./database/init_schema.sql:/docker-entrypoint-initdb.d/01_init_schema.sql
- ./database/sample_data.sql:/docker-entrypoint-initdb.d/02_sample_data.sql
networks:
- compliancebot-network
healthcheck:
test: ["CMD-SHELL", "pg_isready -U compliancebot"]
interval: 30s
timeout: 10s
retries: 3
# Spring Boot Backend
backend:
build:
context: ./backend-java
dockerfile: Dockerfile
container_name: compliancebot-backend
environment:
SPRING_PROFILES_ACTIVE: docker
DB_USERNAME: compliancebot
DB_PASSWORD: password123
ML_SERVICE_URL: http://ml-service:8001
ports:
- "8080:8080"
3.9 Docker Compose Completo

depends_on:
postgres:
condition: service_healthy
ml-service:
condition: service_started
networks:
- compliancebot-network
healthcheck:
test: ["CMD-SHELL", "curl -f http://localhost:8080/api/v1/empresas/estadisticas/ind
interval: 30s
timeout: 10s
retries: 3
start_period: 60s
# ML Service Python
ml-service:
build:
context: ./ml-service-python
dockerfile: Dockerfile
container_name: compliancebot-ml
ports:
- "8001:8001"
networks:
- compliancebot-network
healthcheck:
test: ["CMD-SHELL", "curl -f http://localhost:8001/ || exit 1"]
interval: 30s
timeout: 10s
retries: 3
# Swagger UI (Documentación)
swagger-ui:
image: swaggerapi/swagger-ui
container_name: compliancebot-docs
ports:
- "8082:8080"
environment:
SWAGGER_JSON: /api-docs
API_URL: http://localhost:8080/api/v1/api-docs
depends_on:
- backend
networks:
- compliancebot-network
volumes:
postgres_data:
networks:
compliancebot-network:
driver: bridge

# ComplianceBot Backend
Backend completo para ComplianceBot - Sistema de Auditorías Automatizadas para MiPymes
## ️Arquitectura
- **Backend Principal**: Spring Boot 3.2 + Java 17
- **Base de Datos**: PostgreSQL 15
- **ML Service**: Python FastAPI
- **Documentación**: OpenAPI/Swagger
- **Contenización**: Docker + Docker Compose
## Características
### ✅ Backend Operativo
- ✅ 8+ endpoints REST funcionales
- ✅ Base de datos con 8 entidades relacionadas
- ✅ Lógica de negocio implementada
- ✅ Validaciones completas
- ✅ Documentación API con Swagger
- ✅ Tests unitarios
### Machine Learning
- ✅ Clasificación de riesgos de compliance
- ✅ Generación de documentos con IA
- ✅ API ML integrada
## Instalación y Ejecución
### Prerequisitos
- Docker & Docker Compose
- Java 17+ (para desarrollo)
- Maven 3.6+ (para desarrollo)
- Python 3.11+ (para ML service)
### Ejecutar con Docker (Recomendado)

----------------------------------------------------------------------------------------------------

### Próximas Funcionalidades
- [ ] Autenticación completa
- [ ] WebSocket para notificaciones tiempo real
- [ ] Reportes PDF automatizados
- [ ] Dashboard analytics
- [ ] API versioning
- [ ] Cache con Redis


-------------------------------------------------------------------------------------------------------